---
title: "Data Exploration"
subtitle: "SKILLS: Data Preparation and Workflow Management - Group 9"
author:
  - "Rabino Tommaso"
  - "Franceschini Emanuele"
  - "Magalotti Bianca"
  - "Tan Colin"
  - "Benmrit Akram"
date: "\\textit{20 October 2024}"
output:
  pdf_document:
    latex_engine: xelatex
    toc: true
    toc_depth: 2
    number_sections: true
    fig_caption: true
header-includes:
  - "\\usepackage[english]{babel}"  # Language
  - "\\usepackage[T1]{fontenc}"  # Font encoding
  - "\\usepackage{mathptmx}"  # Times New Roman font for text
  - "\\usepackage{helvet}"  # Arial-like font for sans-serif
  - "\\usepackage{setspace}"  # Line spacing
  - "\\onehalfspacing"  # 1.5 line spacing
  - "\\usepackage{fancyhdr}"  # Header and footer customization
  - "\\usepackage{titlesec}"  # Section titles formatting
  - "\\usepackage{abstract}"  # Abstract formatting
  - "\\usepackage{caption}"  # Captions customization
  - "\\usepackage{graphicx}"  # Graphics
  - "\\usepackage{amsmath}"  # Math equations
  - "\\usepackage{amssymb}"  # Math symbols
  - "\\usepackage{natbib}"  # Citation style (change as needed)
  - "\\bibliographystyle{apalike}"  # Bibliography style (change as needed)
  - "\\usepackage{hyperref}"  # Hyperlinks and URLs
  - "\\hypersetup{colorlinks=true,linkcolor=blue,citecolor=blue,urlcolor=blue}"
  - "\\usepackage{appendix}"  # Appendix formatting
  - "\\usepackage{enumerate}"  # Enumerate environment
  - "\\pagestyle{fancy}"  # Custom page style
  - "\\fancyhf{}"
  - "\\renewcommand{\\headrulewidth}{0pt}"
  - "\\renewcommand{\\footrulewidth}{0pt}"
  - "\\fancyhead[R]{\\thepage}"  # Page number in the header
  - "\\fancypagestyle{plain}{\\fancyhf{}\\renewcommand{\\headrulewidth}{0pt}}"
  - "\\lhead{\\small{A.A. 2023/2024-Courses: SKILLS: Data Preparation and Workflow Management}}"
  - "\\usepackage{multicol}"  # For two columns
geometry: "left=2.5cm, right=1.5cm, top=2.5cm, bottom=2.5cm"  # Adjust margins
---

```{r, include=FALSE}
knitr::opts_chunk$set(tidy = FALSE,
                      size = "small",
                      out.width = "100%",
                      message = FALSE,
                      warning = FALSE,
                      error = FALSE)
```


```{r, include = FALSE}
###############################################################
#############             PACKAGES               ##############
###############################################################
#GENERAL PACKAGES:
library(tidyverse) #A "Package of Packages" for Data manipulation and visualization (includes magrittr, lubridate, purrr, tidyr, etc.).
library(dplyr) #Data frame manipulations (select, slice, etc.
library(jsonlite) #For Amenities Columns Creation

#PLOT PACKAGES:
library(ggplot2) #Building fancy plots.
library(ggthemes) #Themes for ggplots (e.g. "solarized").
library(ggcorrplot) #For correlograms
library(scales) #Scaling and formatting ggplots (e.g. scale_fill_gradient()).
library(gt) #Latex tables
```


```{r, echo=FALSE}
# Load the R object
clean_data <- readRDS("../../gen/data-preparation/input/clean_data.rds")
```



\section{Correlation Analysis}
This section is structured as follows:

\begin{enumerate}
  \item Correlation Analysis of Apartment-related Variables: In this step, a correlogram is generated to examine the correlations between \textit{numeric}, \textit{apartment-related} variables and the price of the listings.
  \item Correlation Analysis of Host-related Variables: Subsequently, a correlogram is constructed to assess the correlations between \textit{numeric}, \textit{host-related} variables and the price of the listings.
  \item Correlation Analysis of All Numeric Variables: Lastly, a correlogram is produced, including all numeric variables (\textit{apartment-related} and \textit{host-related}), to identify variables with high mutual correlations. Identifying such variables is essential to mitigate multicollinearity issues in the final regression model.
\end{enumerate}


\subsection{Apartment-related Variables}
First, the \textit{numeric} variables we considered as \textit{apartment-related} and from which we will build the correlogram were the following: 
```{r, include=FALSE}
# Select relevant variables for correlation analysis
corr_data <- clean_data %>% 
  dplyr::select(
    price, latitude, longitude, accommodates, bedrooms, beds, bathrooms, minimum_nights,
    maximum_nights, availability_30, availability_60, availability_90, availability_365,
    number_of_reviews, number_of_reviews_ltm, number_of_reviews_l30d, reviews_per_month,
    review_scores_rating, review_scores_accuracy, review_scores_cleanliness, review_scores_location,
    review_scores_value
  )

# Extract the column names as a data frame
column_names_df <- data.frame(Variable = colnames(corr_data))

# Create a gt table with one column
t8 <- column_names_df %>%
  gt() %>%
  tab_header(
    title = "Variable Names",
    subtitle = "List of Numeric Apartment-related Variables"
  )

```

```{r}
t8
```


Here is a correlogram displaying correlation values for the variables selected in the previous step:
```{r, include=FALSE}
# Create a correlation matrix
corr_matrix <- round(cor(corr_data),2)

# Define custom color palette
my_colors <- c("#E6E6E6", "#FFFFFF", "#CCCCCC")

# Restyled correlogram plot
p6 <- ggcorrplot(corr_matrix,
           hc.order = FALSE,
           method = "square",
           type = "lower",
           outline.col = "white",
           colors = my_colors,
           lab = TRUE, 
           lab_size = 2.5,
           digits = 2,
           tl.cex = 8,
           title = "Apartment-related Correlogram") +
  theme(legend.position = "none", 
        plot.title = element_text(lineheight = 2, face = "bold", vjust = 1, hjust = 0.5, color = "#333333"),
        plot.subtitle = element_text(color = "#666666", vjust = 1, hjust = 0.5),
        axis.title = element_text(color = "#666666"), 
        axis.text = element_text(color = "#666666"))

```

```{r}
p6
```


To improve clarity, we created a table displaying the correlation of each variable with \texttt{price}. Additionally, we've organized the variables in descending order based on their correlation with \texttt{price} to enhance interpretation.

The table below reveals that certain variables exhibit a stronger correlation with \texttt{price}. Notably, bathrooms (0.50), accommodates (0.41), bedrooms (0.41), and beds (0.30) show the highest positive correlations. This suggests that, as expected, larger properties tend to command higher prices. Conversely, the \texttt{review\_score} variables display relatively weak correlations with \texttt{price}.

```{r, include=FALSE}
# Convert correlation matrix into a dataframe
corr_matrix_df <- data.frame(corr_matrix)

# Add a new column for variable names
corr_matrix_df$Variable <- row.names(corr_matrix_df)

# Select the "Variable" and "price" columns
corr_matrix_df <- corr_matrix_df %>%
  select(Variable, price) %>%
  arrange(desc(price))

# Rename the columns
colnames(corr_matrix_df) <- c("Variable", "Correlation")


t9 <- corr_matrix_df %>%
  gt() %>%
  tab_style(
    style = cell_text(weight = "bold"),
    locations = cells_column_labels(columns = everything())
  ) %>%
  tab_header(
    title = "Correlation with Price",
    subtitle = "Correlation between Variables and Price"
  )
```

```{r}
t9
```




```{r, include=FALSE}
rm(corr_data, corr_matrix, t8, p6, t9, corr_matrix_df, my_colors, column_names_df)
```


\subsection{Host-related Variables}
First of all, we wanted to include in the correlation matrix also some \texttt{date} variables. Therefore, we extracted the year from \texttt{host\_since} and \texttt{first\_review}, and the month from \texttt{last\_review}. Then, we converted these two new variables into numeric.
```{r}
corr_data <- clean_data %>%
  mutate(host_since_year = as.numeric(year(host_since)),
         first_review_year = as.numeric(year(first_review)),
         last_review_day = as.numeric(month(last_review)))
```

Below is the list of \textit{numeric} variables we considered as \textit{host-related} and from which we will build the following correlogram. 
```{r, include=FALSE}
# Select relevant variables
corr_data <- corr_data %>% 
  dplyr::select(price, host_since_year, first_review_year, last_review_day, host_response_rate_percentage, host_acceptance_rate_percentage, host_listings_count, host_total_listings_count, review_scores_checkin, review_scores_communication, reviews_per_month)

# Extract the column names as a data frame
column_names_df <- data.frame(Variable = colnames(corr_data))

# Create a gt table with one column
t10 <- column_names_df %>%
  gt() %>%
  tab_header(
    title = "Variable Names",
    subtitle = "List of Numeric Host-related Variables"
  )
```

```{r}
t10
```


Here is a correlogram displaying correlation values for the variables selected in the previous step:
```{r, include=FALSE}
corr_matrix <- round(cor(corr_data),2)

# Define custom color palette
my_colors <- c("#E6E6E6", "#FFFFFF", "#CCCCCC")

# Restyled correlogram plot
p7 <- ggcorrplot(corr_matrix,
           hc.order = FALSE,
           method = "square",
           type = "lower",
           outline.col = "white",
           colors = my_colors,
           lab = TRUE, 
           lab_size = 2.5,
           digits = 2,
           tl.cex = 8,
           title = "Apartment-related Correlogram") +
  theme(legend.position = "none", 
        plot.title = element_text(lineheight = 2, face = "bold", vjust = 1, hjust = 0.5, color = "#333333"),
        plot.subtitle = element_text(color = "#666666", vjust = 1, hjust = 0.5),
        axis.title = element_text(color = "#666666"), 
        axis.text = element_text(color = "#666666"))

```

```{r}
p7
```


To improve clarity, we created a table displaying the correlation of each variable with \texttt{price}. Additionally, we've organized the variables in descending order based on their correlation with \texttt{price} to enhance interpretation.

The table below reveals that certain variables exhibit a stronger correlation with \texttt{price}. Notably, \texttt{host\_acceptance\_rate\_percentage} (0.07), \texttt{host\_listings\_count} (0.07), and \texttt{host\_total\_listings\_count}	(0.07) show the highest positive correlations. Conversely, \texttt{host\_since\_year} displays relatively weak correlations with \texttt{price} (-0.07). In general, \texttt{host-related} variables show weaker correlations with \texttt{price} if compared to \texttt{apartment-related} variables.

```{r, include=FALSE}
# Convert correlation matrix into a dataframe
corr_matrix_df <- data.frame(corr_matrix)

# Add a new column for variable names
corr_matrix_df$Variable <- row.names(corr_matrix_df)

# Select the "Variable" and "price" columns
corr_matrix_df <- corr_matrix_df %>%
  select(Variable, price) %>%
  arrange(desc(price))

# Rename the columns
colnames(corr_matrix_df) <- c("Variable", "Correlation")


t11 <- corr_matrix_df %>%
  gt() %>%
  tab_style(
    style = cell_text(weight = "bold"),
    locations = cells_column_labels(columns = everything())
  ) %>%
  tab_header(
    title = "Correlation with Price",
    subtitle = "Correlation between Variables and Price"
  )
```

```{r}
t11
```


```{r, include=FALSE}
rm(corr_data, corr_matrix, t10, p7, t11, corr_matrix_df, my_colors, column_names_df)
```


\subsection{All Numeric Variables Correlations}
Here is a correlogram displaying correlation values for all numeric variables and \texttt{price}.
```{r, include=FALSE}
corr_data <- clean_data %>% dplyr::select_if(is.numeric)

corr_matrix <- round(cor(corr_data),2)

# Define custom color palette
my_colors <- c("#E6E6E6", "#FFFFFF", "#CCCCCC")

# Restyled correlogram plot
p8 <- ggcorrplot(corr_matrix,
           hc.order = FALSE,
           method = "square",
           type = "lower",
           outline.col = "white",
           colors = my_colors,
           lab = TRUE, 
           lab_size = 2.5,
           digits = 2,
           tl.cex = 8,
           title = "Apartment-related Correlogram") +
  theme(legend.position = "none", 
        plot.title = element_text(lineheight = 2, face = "bold", vjust = 1, hjust = 0.5, color = "#333333"),
        plot.subtitle = element_text(color = "#666666", vjust = 1, hjust = 0.5),
        axis.title = element_text(color = "#666666"), 
        axis.text = element_text(color = "#666666"))

```

```{r}
p8
```


To improve clarity, we created a table displaying the pairs of numeric variables with a mutual correlation higher than 0.75. Additionally, we've organized the variables in descending order based on their mutual correlation to enhance interpretation.
Thi table helps in identifying highly correlated variables for potential removal to avoid multicollinearity in regression analysis.
```{r, include=FALSE}
# Convert correlation matrix into a dataframe
corr_matrix_df <- data.frame(corr_matrix)

# Add a new column for variable names
corr_matrix_df$Variable <- row.names(corr_matrix_df)

# Define the threshold for correlation
threshold <- 0.75

# Create a data frame to store pairs of highly correlated variables
high_corr_pairs <- data.frame(Variable1 = character(0), Variable2 = character(0), Correlation = numeric(0))

# Loop through the rows and columns of the correlation matrix
for (i in 1:nrow(corr_matrix)) {
  for (j in 1:ncol(corr_matrix)) {
    if (i < j && abs(corr_matrix[i, j]) > threshold) {
      high_corr_pairs <- rbind(high_corr_pairs, 
                               data.frame(Variable1 = rownames(corr_matrix)[i],
                                          Variable2 = colnames(corr_matrix)[j],
                                          Correlation = corr_matrix[i, j]))
    }
  }
}

#Arrange order: 
high_corr_pairs <- high_corr_pairs %>% arrange(desc(high_corr_pairs$Correlation))

t12 <- high_corr_pairs %>%
  gt() %>%
  tab_style(
    style = cell_text(weight = "bold"),
    locations = cells_column_labels(columns = everything())
  ) %>%
  tab_header(
    title = "Highly Correlated Variable Pairs",
    subtitle = paste("Pairs with correlation > ", threshold),
  )

```

```{r}
t12
```


The code snippet below is utilized to eliminate one variable from the \texttt{clean\_data} dataframe for each pair of highly correlated variables previously identified. The criterion for removal is to discard the variable with the lowest correlation with \texttt{price}. Between the highly correlated variables, we decided to retain only beds, accommodates, and bedroom, since their very high correlation with \texttt{price}.
```{r}
clean_data <- clean_data %>% dplyr::select(-host_total_listings_count, -availability_90, -availability_30, -review_scores_value, -review_scores_accuracy, -reviews_per_month, -review_scores_checkin)
```


```{r, include=FALSE}
rm(corr_data, corr_matrix, p8, t12, corr_matrix_df, my_colors, i, j, threshold, high_corr_pairs)
```



\section{Exploratory Data Analysis}

\subsection{Amenities-related Variables}
This code chunk iterates through all the \texttt{amenities-related} variables within the dataframe, ranging from variable 35 to 127. Then, it computes the median price difference between listings that offer a specific amenity and those that do not.
```{r}
# Create an empty dataframe to store the results
median_diff_df <- data.frame(Variable_Name = character(0), Median_Difference = numeric(0))

# Loop through variables 35 to 127
for (i in 35:127) {
  # Select the relevant columns and group by Bidet
  amenities_df <- clean_data %>%
    select(price, all_of(i)) %>%
    group_by(across(all_of(names(.)[2]))) %>%
    summarize(median_price = median(price))
  
  # Calculate the median difference
  median_diff <- amenities_df$median_price[2] - amenities_df$median_price[1]
  
  # Append the result to the dataframe
  median_diff_df <- rbind(median_diff_df, data.frame(Variable_Name = colnames(clean_data)[i], Median_Difference = median_diff))
}
```

The following table, as well as the following plot, displays the top ten median price differences among all amentity. 
```{r, include=FALSE}
# Arrange the dataframe by Median_Difference in descending order
median_diff_df <- head(median_diff_df, 10) %>%
  arrange(desc(Median_Difference))

t13 <- median_diff_df %>%
  gt() %>%
  tab_header(
    title = "Median Price Differences by Variable",
    subtitle = "Differences in median price between two groups"
  ) %>%
  fmt_number(
    columns = everything(),
    decimals = 2
  )
```

```{r}
t13
```


```{r, include=FALSE}
p9 <- ggplot(median_diff_df, aes(reorder(Variable_Name, Median_Difference), Median_Difference)) +
  geom_col(aes(fill = Median_Difference)) +
  scale_fill_gradient(low = "#FFFFFF", high = "#666666") +
  geom_label(aes(label = paste(Median_Difference, "€")), fill = "#666666", col = "white", size = 2) +
  labs(x = "Variables",
       y = "Median Price Difference",
       title = "Top 10 Variables with Highest Median Price Differences",
       subtitle = "Data collected from Listings dataset") +
  theme(legend.position = "none",
        plot.title = element_text(size = 18, lineheight = 0.8, face = "bold", vjust = 1, hjust = 0.5, color = "black"),
        plot.subtitle = element_text(size = 12, lineheight = 0.8, vjust = 1, hjust = 0.5, color = "black"),
        axis.title = element_text(size = 14, color = "black"),
        axis.text = element_text(size = 8, color = "#666666"),
        panel.grid.major = element_line(color = "gray", size = 0.5),
        panel.grid.minor = element_blank(),
        panel.background = element_rect(fill = "white")) +
  coord_flip()

```

```{r}
p9
```


```{r}
rm(i, median_diff, t13, p9, median_diff_df, amenities_df)
```















